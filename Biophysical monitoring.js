
var collection = ee.ImageCollection('MODIS/MYD13A1').select('EVI');

var reference = collection.filterDate('2001-01-01', '2010-12-31')
  .sort('system:time_start', false);

var mean = reference.mean();

var vis = {min: 1000, max: 5000, palette: ['fdff42','4bff0f','0fa713']};
Map.addLayer(mean, vis, 'reference EVI');

var series = collection.filterDate('2011-01-01', '2014-12-31');

var subtractmean = function(image) {
  return image.subtract(mean)
      .copyProperties(image, ['system:time_start']);
};

var anomalies = series.map(subtractmean);


Map.addLayer(anomalies.sum(), {
  min: -5000, 
  max: 5000, 
  palette: [
    '931206','ff1b05','fdff42','4bff0f','0fa713'
  ]}, 'cumulative anomaly');


var time0 = reference.first().get('system:time_start');


var first = ee.List([
  ee.Image(0).set('system:time_start', time0).rename('EVI')
]);

var accumulate = function(image, list) {
  var previous = ee.Image(ee.List(list).get(-1));
  var added = image.add(previous)
    .set('system:time_start', image.get('system:time_start'));
  return ee.List(list).add(added);
};

var cumulative = ee.ImageCollection(ee.List(
  anomalies.iterate(accumulate, first)
));


var geometry = /* color: #d63000 */ee.Geometry.Polygon(
        [[[-70.19096374511719, 9.339994640217904],
          [-70.1865005493164, 9.356255278610018],
          [-70.1755142211914, 9.367095281883634],
          [-70.16693115234375, 9.373531373788017],
          [-70.16281127929688, 9.376241271522577],
          [-70.15766143798828, 9.380306078441043],
          [-70.14942169189453, 9.385387020096225],
          [-70.13465881347656, 9.393855090673826],
          [-70.11955261230469, 9.402661664434515],
          [-70.11199951171875, 9.402661664434515],
          [-70.10856628417969, 9.408080983043936],
          [-70.09483337402344, 9.415193709821892],
          [-70.07698059082031, 9.420274139314289],
          [-70.06290435791016, 9.430773456713213],
          [-70.05638122558594, 9.440933782190058],
          [-70.05260467529297, 9.447029833692698],
          [-70.04058837890625, 9.457528336042312],
          [-70.03372192382812, 9.46464004269247],
          [-70.0265121459961, 9.474122089300826],
          [-70.02857208251953, 9.484958393336216],
          [-70.03887176513672, 9.494439878506444],
          [-70.0436782836914, 9.499857752235737],
          [-70.05123138427734, 9.50121220727473],
          [-70.059814453125, 9.50121220727473],
          [-70.07320404052734, 9.50121220727473],
          [-70.07869720458984, 9.507645795516236],
          [-70.07869720458984, 9.512047654607958],
          [-70.07835388183594, 9.520851202772599],
          [-70.07423400878906, 9.53168602752469],
          [-70.07560729980469, 9.537780465290066],
          [-70.08384704589844, 9.541504790310205],
          [-70.08590698242188, 9.532363192652976],
          [-70.09552001953125, 9.529315938993562],
          [-70.09620666503906, 9.523898531984143],
          [-70.0927734375, 9.517465249545603],
          [-70.10101318359375, 9.514756462809098],
          [-70.09963989257812, 9.501889432784724],
          [-70.09929656982422, 9.495455736358661],
          [-70.10856628417969, 9.501889432784724],
          [-70.12676239013672, 9.507645795516236],
          [-70.13191223144531, 9.505952757705797],
          [-70.13877868652344, 9.497148826084286],
          [-70.14461517333984, 9.489021919095157],
          [-70.15594482421875, 9.481910717417648],
          [-70.16246795654297, 9.477847107409653],
          [-70.16830444335938, 9.46971974306858],
          [-70.17791748046875, 9.467349225571997],
          [-70.17654418945312, 9.46396274363553],
          [-70.19233703613281, 9.461592186426515],
          [-70.19920349121094, 9.457189679675986],
          [-70.2077865600586, 9.452787116575726],
          [-70.21499633789062, 9.434160265140793],
          [-70.22048950195312, 9.426031869051675],
          [-70.22357940673828, 9.41248411687915],
          [-70.22392272949219, 9.400629398069338],
          [-70.22323608398438, 9.382338464037366],
          [-70.21980285644531, 9.36980522985784],
          [-70.21808624267578, 9.356255278610018],
          [-70.21087646484375, 9.341349722426134],
          [-70.20401000976562, 9.33694568597786],
          [-70.19062042236328, 9.336606911637636]]]);

var geometry2 = /* color: #98ff00 */ee.Geometry.Polygon(
        [[[-69.46002960205078, 10.024638805124969],
          [-69.4504165649414, 10.00976288931099],
          [-69.35428619384766, 10.035795294012027],
          [-69.31411743164062, 10.063177772389452],
          [-69.27703857421875, 10.05067001445113],
          [-69.25128936767578, 10.07095262098172],
          [-69.29557800292969, 10.109824050596263],
          [-69.3460464477539, 10.095290065445113],
          [-69.3790054321289, 10.099684130226265],
          [-69.42192077636719, 10.046951398466547]]]);

Map.centerObject(geometry);
Map.addLayer(geometry, {}, 'geometry');
Map.addLayer(geometry2, {}, 'geometry2');


var title = { 
 title: 'Cumulative EVI anomaly over time',
  hAxis: {title: 'Time'},
  vAxis: {title: 'Cumulative EVI anomaly'},
};


var chart = ui.Chart.image.seriesByRegion({
  imageCollection: cumulative, 
  regions: geometry, 
  reducer: ee.Reducer.mean(), 
  band: 'EVI', 
  scale: 500, 
  xProperty: 'system:time_start', 
  seriesProperty: 'PROJECT'
});

var chart2 = ui.Chart.image.seriesByRegion({
  imageCollection: cumulative, 
  regions: geometry2, 
  reducer: ee.Reducer.mean(), 
  band: 'EVI', 
  scale: 500, 
  xProperty: 'system:time_start', 
  seriesProperty: 'PROJECT'
});

print(chart.setOptions(title));

print(chart2.setOptions(title));



